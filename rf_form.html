<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Trimitere coordonate RF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: sans-serif;
        background: #f2f2f2;
        padding: 20px;
        color: #333;
      }
      input,
      button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        box-sizing: border-box;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.7;
      }
      input[readonly] {
        background-color: #f8f9fa;
      }
      .container {
        max-width: 400px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
      }
    </style>
    <script>
      function preiaLocatia() {
        if (!navigator.geolocation) {
          alert("GPS nu e suportat de acest browser.")
          return
        }

        // Check if we're on HTTPS or localhost (required for geolocation on mobile)
        const isSecureContext =
          window.isSecureContext ||
          location.protocol === "https:" ||
          location.hostname === "localhost"
        if (!isSecureContext) {
          alert(
            "âš ï¸ ATENÈšIE: Geolocation necesitÄƒ HTTPS pe dispozitivele mobile. ÃŽncercaÈ›i sÄƒ accesaÈ›i prin HTTPS sau sÄƒ utilizaÈ›i un browser care permite HTTP pentru geolocation."
          )
        }

        // Disable the refresh button and show loading state
        const refreshBtn = document.querySelector(
          'button[onclick="preiaLocatia()"]'
        )
        const originalText = refreshBtn.textContent
        refreshBtn.disabled = true
        refreshBtn.textContent = "ðŸ”„ Se obÈ›ine locaÈ›ia..."

        // Clear current values to show we're getting new ones
        document.getElementById("lat").value = "Se Ã®ncarcÄƒ..."
        document.getElementById("lon").value = "Se Ã®ncarcÄƒ..."
        document.getElementById("azim").value = ""

        navigator.geolocation.getCurrentPosition(
          function (pos) {
            document.getElementById("lat").value =
              pos.coords.latitude.toFixed(6)
            document.getElementById("lon").value =
              pos.coords.longitude.toFixed(6)
            if (
              pos.coords.heading !== null &&
              pos.coords.heading !== undefined
            ) {
              document.getElementById("azim").value =
                pos.coords.heading.toFixed(1)
            }

            // Re-enable button and show success
            refreshBtn.disabled = false
            refreshBtn.textContent = originalText
            alert("âœ… LocaÈ›ia a fost actualizatÄƒ cu succes!")
          },
          function (err) {
            // Re-enable button on error
            refreshBtn.disabled = false
            refreshBtn.textContent = originalText

            // Clear loading text
            document.getElementById("lat").value = ""
            document.getElementById("lon").value = ""

            let errorMsg = "âŒ Eroare GPS: "
            let suggestions = ""

            switch (err.code) {
              case 1:
                errorMsg += "Accesul la locaÈ›ie a fost refuzat."
                suggestions =
                  "\n\nðŸ’¡ SoluÈ›ii:\nâ€¢ VerificaÈ›i setÄƒrile browser-ului pentru locaÈ›ie\nâ€¢ ÃŽncercaÈ›i sÄƒ reÃ®mprospÄƒtaÈ›i pagina\nâ€¢ Pe mobile: verificaÈ›i setÄƒrile de locaÈ›ie din Settings"
                break
              case 2:
                errorMsg += "PoziÈ›ia nu este disponibilÄƒ."
                suggestions =
                  "\n\nðŸ’¡ SoluÈ›ii:\nâ€¢ VerificaÈ›i cÄƒ GPS-ul este activat\nâ€¢ ÃŽncercaÈ›i sÄƒ ieÈ™iÈ›i Ã®n exterior\nâ€¢ VerificaÈ›i conexiunea la internet"
                break
              case 3:
                errorMsg += "Timeout - timpul de aÈ™teptare a expirat."
                suggestions =
                  "\n\nðŸ’¡ SoluÈ›ii:\nâ€¢ ÃŽncercaÈ›i din nou\nâ€¢ VerificaÈ›i semnalul GPS\nâ€¢ IeÈ™iÈ›i Ã®n exterior pentru semnal mai bun"
                break
              default:
                errorMsg += err.message
                break
            }

            // Add context info for debugging
            const contextInfo = `\n\nðŸ”§ Info tehnic:\nâ€¢ Browser: ${
              navigator.userAgent.includes("Mobile") ? "Mobile" : "Desktop"
            }\nâ€¢ HTTPS: ${
              location.protocol === "https:" ? "Da" : "Nu"
            }\nâ€¢ URL: ${location.href}`

            alert(errorMsg + suggestions + contextInfo)
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0, // Don't use cached location, get fresh one
          }
        )
      }

      function trimiteDate() {
        const lat = document.getElementById("lat").value
        const lon = document.getElementById("lon").value
        const azim = document.getElementById("azim").value

        const serverUrl = window.location.origin
        fetch(`${serverUrl}/adauga`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat, lon, azim }),
        })
          .then((r) => r.json())
          .then((data) => alert(data.mesaj))
          .catch((err) => alert("Eroare: " + err))
      }
    </script>
  </head>
  <body onload="preiaLocatia()">
    <div class="container">
      <h2>ðŸ“¡ Trimite Coordonate RF</h2>
      <label>Latitudine:</label>
      <input id="lat" readonly />
      <label>Longitudine:</label>
      <input id="lon" readonly />
      <label>Azimut (Â°):</label>
      <input id="azim" placeholder="OpÈ›ional dacÄƒ nu e detectat" />
      <button
        onclick="preiaLocatia()"
        style="background-color: #28a745; margin-bottom: 10px"
      >
        ðŸ”„ ReÃ®mprospÄƒteazÄƒ LocaÈ›ia
      </button>
      <button onclick="trimiteDate()">ðŸ“¤ Trimite cÄƒtre Server</button>
    </div>
  </body>
</html>
